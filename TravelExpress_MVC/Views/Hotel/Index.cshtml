@model IEnumerable<TravelExpress.Models.HotelApi>

@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    bool isUser = false;
    var today = DateTime.Today.ToString("yyyy-MM-dd");

    if (SignInManager.IsSignedIn(User))
    {
        var currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            var roles = await UserManager.GetRolesAsync(currentUser);
            isUser = roles.Contains("User");
        }
    }
}

<h2 class="mb-4">🏨 Browse Hotels</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (isUser)
{
    <div class="p-4 mb-5 border rounded bg-light shadow-sm">
        <form asp-action="Search" method="get" class="row g-3" autocomplete="off" id="searchForm">
            <div class="col-md-4">
                <input id="location" name="location" class="form-control" placeholder="Enter location (e.g., Delhi)" required />
            </div>
            <div class="col-md-3">
                <input id="checkIn" name="checkIn" type="date" class="form-control" min="@today" required />
            </div>
            <div class="col-md-3">
                <input id="checkOut" name="checkOut" type="date" class="form-control" min="@today" required />
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Search</button>
            </div>
        </form>
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-warning">No hotels available.</div>
}
else
{
    <table class="table table-striped shadow-sm">
        <thead style="background-color: #007bff; color: white;">
            <tr>
                <th>S.No</th>
                <th>Name</th>
                <th>Location</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count(); i++)
            {
                var hotel = Model.ElementAt(i);
                <tr>
                    <td>@(i + 1)</td>
                    <td>@hotel.Name</td>
                    <td>@hotel.Location</td>
                    <td>
                        <a asp-action="Details" asp-route-id="@hotel.HotelId" class="btn btn-sm btn-outline-primary">
                            View Details
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@section Scripts {
    <script>
        window.addEventListener("DOMContentLoaded", () => {
            const checkInInput = document.getElementById("checkIn");
            const checkOutInput = document.getElementById("checkOut");
            const locationInput = document.getElementById("location");

            // Clear inputs on load
            locationInput.value = "";
            checkInInput.value = "";
            checkOutInput.value = "";

            const today = new Date();
            //const todayStr = today.toISOString().split('T')[0];
                const todayStr = today.getFullYear() + '-' +
        String(today.getMonth() + 1).padStart(2, '0') + '-' +
        String(today.getDate()).padStart(2, '0');
            checkInInput.min = todayStr;
            //checkInInput.value = todayStr;

            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            //const tomorrowStr = tomorrow.toISOString().split('T')[0];
                const tomorrowStr = tomorrow.getFullYear() + '-' +
        String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' +
        String(tomorrow.getDate()).padStart(2, '0');
            checkOutInput.min = tomorrowStr;
            //checkOutInput.value = tomorrowStr;

            checkInInput.addEventListener("change", () => {
                const checkInDate = new Date(checkInInput.value);
                const minCheckOut = new Date(checkInDate);
                minCheckOut.setDate(minCheckOut.getDate() + 1);
                const minStr = minCheckOut.toISOString().split('T')[0];
                checkOutInput.min = minStr;

                if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                    checkOutInput.value = "";
                    alert("⚠️ Check-out must be after check-in date.");
                }
            });
        });
    </script>
}
